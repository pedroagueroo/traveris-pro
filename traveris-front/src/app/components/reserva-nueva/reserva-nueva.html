<div class="container-fluid p-4 animate-fade-in">
  <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
    <div>
      <h1 class="h3 fw-bold m-0 text-dark">
        {{ esEdicion ? 'Editar Legajo #' + reservaId : 'Nuevo Legajo Maestro' }}
      </h1>
      <p class="text-muted small mb-0">Gesti√≥n de itinerario integral</p>
    </div>
    <button class="btn-elite shadow-sm px-4" (click)="guardarReserva()">
      <i class="bi" [ngClass]="esEdicion ? 'bi-arrow-repeat' : 'bi-send-check'"></i>
      {{ esEdicion ? 'Guardar Cambios' : 'Emitir Legajo' }}
    </button>
  </header>

  <div class="nav nav-pills mb-4 bg-white p-2 rounded-3 shadow-sm border">
    <button class="nav-link flex-fill" [class.active]="pasoActivo === 1" (click)="irAlPaso(1)">01 General</button>
    <button class="nav-link flex-fill" [class.active]="pasoActivo === 2" (click)="irAlPaso(2)">02 Pasajeros</button>
    <button class="nav-link flex-fill" [class.active]="pasoActivo === 4" (click)="irAlPaso(4)">03 Itinerario y Finanzas</button>
  </div>

  <main class="step-content">
    
    <div *ngIf="pasoActivo === 1" class="glass-card shadow-sm animate-slide-up">
      <h3 class="section-title"><i class="bi bi-info-circle"></i> Datos del Expediente</h3>
      <div class="row g-4">
        <div class="col-md-6">
          <label class="label-tech">TITULAR RESPONSABLE</label>
          <div class="d-flex gap-2">
            <select class="form-select" [(ngModel)]="reserva.id_titular">
              <option value="">-- Seleccionar Cliente --</option>
              <option *ngFor="let c of clientes" [value]="c.id">{{ c.nombre_completo }}</option>
            </select>
            <button type="button" class="btn btn-outline-primary" (click)="abrirModalRapido(-1)">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <label class="label-tech">DESTINO FINAL</label>
          <input type="text" class="form-control" [(ngModel)]="reserva.destino_final" placeholder="Ej: Madrid, Espa√±a">
        </div>
        <div class="col-md-4">
          <label class="label-tech">OPERADOR / MAYORISTA</label>
          <input type="text" class="form-control" [(ngModel)]="reserva.operador_mayorista">
        </div>
        <div class="col-md-4">
          <label class="label-tech">NRO EXPEDIENTE</label>
          <input type="text" class="form-control" [(ngModel)]="reserva.nro_expediente_operador">
        </div>
        <div class="col-md-4">
          <label class="label-tech">COTIZACI√ìN USD</label>
          <input type="number" class="form-control fw-bold text-primary" [(ngModel)]="reserva.cotizacion_dolar">
        </div>
        <div class="col-md-6">
          <label class="label-tech">FECHA SALIDA</label>
          <input type="date" class="form-control" [(ngModel)]="reserva.fecha_viaje_salida">
        </div>
        <div class="col-md-6">
          <label class="label-tech">FECHA REGRESO</label>
          <input type="date" class="form-control" [(ngModel)]="reserva.fecha_viaje_regreso">
        </div>
        <div class="col-12">
          <label class="label-tech">OBSERVACIONES INTERNAS</label>
          <textarea class="form-control" [(ngModel)]="reserva.observaciones_internas" rows="3" placeholder="Notas de uso interno..."></textarea>
        </div>
      </div>
    </div>

    <div *ngIf="pasoActivo === 2" class="glass-card shadow-sm animate-slide-up">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="section-title mb-0"><i class="bi bi-people"></i> Manifiesto de Pasajeros</h3>
        <button class="btn btn-primary btn-sm rounded-pill px-3" (click)="agregarPasajero()">+ A√±adir Pasajero</button>
      </div>
      <div *ngFor="let p of acompaniantes; let i = index" class="p-4 border rounded-3 bg-light mb-3 position-relative">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="label-tech">SELECCIONAR CLIENTE</label>
            <div class="d-flex gap-2">
              <select class="form-select" [(ngModel)]="p.id_cliente">
                <option value="">-- Buscar Pasajero --</option>
                <option *ngFor="let c of clientes" [value]="c.id">{{ c.nombre_completo }}</option>
              </select>
              <button type="button" class="btn btn-outline-primary" (click)="abrirModalRapido(i)">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <label class="label-tech">TIPO</label>
            <select class="form-select" [(ngModel)]="p.tipo_pasajero">
              <option value="ADULTO">Adulto</option>
              <option value="MENOR">Menor</option>
              <option value="INFANTE">Infante</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="label-tech">VENCIMIENTO DOC.</label>
            <input type="date" class="form-control" [(ngModel)]="p.tiene_visa_vencimiento">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-outline-danger w-100" (click)="quitarPasajero(i)">‚úï</button>
          </div>
          <div class="col-md-6">
            <label class="label-tech">NRO P√ìLIZA ASISTENCIA</label>
            <input type="text" class="form-control" [(ngModel)]="p.nro_asistencia_viajero">
          </div>
          <div class="col-md-6">
            <label class="label-tech">NOTAS M√âDICAS / ALERGIAS</label>
            <input type="text" class="form-control" [(ngModel)]="p.notas_medicas_alergias">
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="pasoActivo === 4" class="animate-fade-in">
      <div class="glass-card shadow-sm mb-4">
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <h3 class="section-title m-0">Detalle de Itinerario</h3>
            <p class="text-muted small">Desglose de servicios y costos para rentabilidad.</p>
          </div>
          <div class="btn-group shadow-sm">
            <button class="btn btn-outline-secondary btn-sm" (click)="agregarServicio('VUELO')">‚úàÔ∏è Vuelo</button>
            <button class="btn btn-outline-secondary btn-sm" (click)="agregarServicio('HOTEL')">üè® Hotel</button>
            <button class="btn btn-outline-secondary btn-sm" (click)="agregarServicio('CRUCERO')">üö¢ Crucero</button>
            <button class="btn btn-outline-secondary btn-sm" (click)="agregarServicio('ASISTENCIA')">üè• Asistencia</button>
            <button class="btn btn-outline-secondary btn-sm" (click)="agregarServicio('SERVICIO')">‚öôÔ∏è Otros Servicios</button>
          </div>
        </div>

        <div class="services-stack">
          <div *ngFor="let s of servicios; let i = index" class="border rounded-4 p-4 mb-4 bg-white shadow-xs animate-slide-up">
            
            <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
              <span class="badge bg-dark text-white px-3 py-2 rounded-pill fw-bold" style="font-size: 0.7rem;">
                {{ s.tipo_item }}
              </span>
              <button class="btn btn-link text-danger btn-sm p-0 fw-bold text-decoration-none" (click)="quitarServicio(i)">
                <i class="bi bi-trash3 me-1"></i> Eliminar Item
              </button>
            </div>

            <div class="service-body">
              <div [ngSwitch]="s.tipo_item" class="row g-3 mb-4">
                
                <ng-container *ngSwitchCase="'VUELO'">
                  <div class="col-md-3"><label class="label-tech">AEROL√çNEA</label><input type="text" class="form-control" [(ngModel)]="s.detalles.aerolinea"></div>
                  <div class="col-md-2"><label class="label-tech">VUELO #</label><input type="text" class="form-control" [(ngModel)]="s.detalles.nro_vuelo"></div>
                  <div class="col-md-2"><label class="label-tech">RUTA (IATA)</label><input type="text" class="form-control" [(ngModel)]="s.detalles.origen" placeholder="EZE-MAD"></div>
                  <div class="col-md-2"><label class="label-tech">PNR</label><input type="text" class="form-control fw-bold" [(ngModel)]="s.detalles.pnr"></div>
                  <div class="col-md-3"><label class="label-tech">FECHA SALIDA</label><input type="date" class="form-control" [(ngModel)]="s.detalles.fecha"></div>
                </ng-container>

                <ng-container *ngSwitchCase="'HOTEL'">
                  <div class="col-md-4"><label class="label-tech">NOMBRE HOTEL</label><input type="text" class="form-control" [(ngModel)]="s.detalles.hotel_nombre"></div>
                  <div class="col-md-2"><label class="label-tech">CIUDAD</label><input type="text" class="form-control" [(ngModel)]="s.detalles.ciudad"></div>
                  <div class="col-md-2"><label class="label-tech">CHECK IN</label><input type="date" class="form-control" [(ngModel)]="s.detalles.check_in"></div>
                  <div class="col-md-2"><label class="label-tech">CHECK OUT</label><input type="date" class="form-control" [(ngModel)]="s.detalles.check_out"></div>
                  <div class="col-md-2">
                    <label class="label-tech">R√âGIMEN</label>
                    <select class="form-select" [(ngModel)]="s.detalles.regimen">
                      <option value="DESAYUNO">Desayuno</option>
                      <option value="MEDIA_PENSION">Media Pensi√≥n</option>
                      <option value="ALL_INCLUSIVE">All Inclusive</option>
                    </select>
                  </div>
                </ng-container>

                <ng-container *ngSwitchCase="'CRUCERO'">
                  <div class="col-md-5"><label class="label-tech">NOMBRE CRUCERO / NAVIERA</label><input type="text" class="form-control" [(ngModel)]="s.detalles.crucero_nombre"></div>
                  <div class="col-md-3"><label class="label-tech">CABINA / CATEGOR√çA</label><input type="text" class="form-control" [(ngModel)]="s.detalles.crucero_cabina"></div>
                  <div class="col-md-2"><label class="label-tech">EMBARQUE</label><input type="date" class="form-control" [(ngModel)]="s.detalles.check_in"></div>
                  <div class="col-md-2"><label class="label-tech">DESEMBARQUE</label><input type="date" class="form-control" [(ngModel)]="s.detalles.check_out"></div>
                  <div class="col-12"><label class="label-tech">ITINERARIO / PUERTOS</label><textarea class="form-control" rows="2" [(ngModel)]="s.detalles.crucero_itinerario"></textarea></div>
                </ng-container>

                <ng-container *ngSwitchCase="'ASISTENCIA'">
                  <div class="col-md-4"><label class="label-tech">PLAN COBERTURA</label><input type="text" class="form-control" [(ngModel)]="s.detalles.plan"></div>
                  <div class="col-md-3"><label class="label-tech">NRO P√ìLIZA</label><input type="text" class="form-control" [(ngModel)]="s.detalles.nro_poliza"></div>
                  <div class="col-md-5"><label class="label-tech">DETALLES EMERGENCIA</label><input type="text" class="form-control" [(ngModel)]="s.detalles.cobertura"></div>
                </ng-container>

                <ng-container *ngSwitchCase="'VISA'">
                  <div class="col-md-4"><label class="label-tech">PA√çS DESTINO</label><input type="text" class="form-control" [(ngModel)]="s.detalles.pais"></div>
                  <div class="col-md-4"><label class="label-tech">NRO TR√ÅMITE</label><input type="text" class="form-control" [(ngModel)]="s.detalles.nro_tramite"></div>
                  <div class="col-md-4"><label class="label-tech">VENCIMIENTO</label><input type="date" class="form-control" [(ngModel)]="s.detalles.fecha_vencimiento"></div>
                </ng-container>

                <ng-container *ngSwitchCase="'SERVICIO'">
                  <div class="col-md-8"><label class="label-tech">TIPO DE SERVICIO (Ej: Traslado Privado)</label><input type="text" class="form-control" [(ngModel)]="s.detalles.nombre_servicio"></div>
                  <div class="col-md-4"><label class="label-tech">FECHA SERVICIO</label><input type="date" class="form-control" [(ngModel)]="s.detalles.fecha"></div>
                  <div class="col-12"><label class="label-tech">DETALLES DEL SERVICIO (ESPACIO DE ESCRITURA)</label>
                    <textarea class="form-control" rows="4" [(ngModel)]="s.detalles.servicio_descripcion" placeholder="Escriba aqu√≠ todos los detalles, horarios, puntos de encuentro..."></textarea>
                  </div>
                </ng-container>
              </div>

              <div class="row g-3 p-3 rounded-3" style="background-color: #f8fafc; border: 1px dashed var(--border);">
                <div class="col-md-6">
                  <label class="label-tech text-primary">COSTO NETO OPERADOR (USD)</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 small">USD</span>
                    <input type="number" class="form-control border-start-0 fw-bold" [(ngModel)]="s.costo_neto_operador" (input)="recalcularTodo()">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="label-tech text-success">VENTA BRUTA CLIENTE (USD)</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 text-success small">USD</span>
                    <input type="number" class="form-control border-start-0 fw-bold text-success" [(ngModel)]="s.venta_bruta_cliente" (input)="recalcularTodo()">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-4">
          <div class="col-md-4">
            <div class="p-4 bg-light rounded-4 text-center border">
              <span class="label-tech">INVERSI√ìN TOTAL</span>
              <div class="h3 fw-bold mb-0 text-dark">USD {{ totalCostoNeto | number:'1.2-2' }}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-4 bg-white rounded-4 text-center border-bottom border-3 border-primary shadow-sm">
              <span class="label-tech text-primary">VENTA FINAL CLIENTE</span>
              <div class="h3 fw-bold mb-0 text-primary">USD {{ reserva.total_venta_final_usd | number:'1.2-2' }}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-4 bg-success bg-opacity-10 rounded-4 text-center border border-success border-opacity-25">
              <span class="label-tech text-success">BENEFICIO NETO AGENCIA</span>
              <div class="h3 fw-bold mb-0 text-success">USD {{ (reserva.total_venta_final_usd - totalCostoNeto) | number:'1.2-2' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal-backdrop fade show" *ngIf="mostrarModalCliente"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="mostrarModalCliente">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="fw-bold">Registro R√°pido de Cliente</h5>
        <button type="button" class="btn-close" (click)="mostrarModalCliente = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3">
          <label class="label-tech">Nombre Completo</label>
          <input type="text" class="form-control" [(ngModel)]="nuevoClienteRapido.nombre_completo">
        </div>
        <div class="mb-3">
          <label class="label-tech">DNI / Pasaporte</label>
          <input type="text" class="form-control" [(ngModel)]="nuevoClienteRapido.dni_pasaporte">
        </div>
        <div class="mb-3">
          <label class="label-tech">Email (Opcional)</label>
          <input type="email" class="form-control" [(ngModel)]="nuevoClienteRapido.email">
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light" (click)="mostrarModalCliente = false">Cancelar</button>
        <button type="button" class="btn btn-elite" (click)="guardarClienteRapido()">Guardar y Seleccionar</button>
      </div>
    </div>
  </div>
</div>