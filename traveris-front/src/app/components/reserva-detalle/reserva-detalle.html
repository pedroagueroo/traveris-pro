<div class="container-fluid p-4" *ngIf="reserva">
  <div class="glass-card mb-4 d-flex justify-content-between align-items-center py-3">
    <div>
      <span class="badge bg-light text-dark border mb-1">EXPEDIENTE #{{ reserva.id }}</span>
      <h2 class="h4 fw-bold m-0 text-uppercase">{{ reserva.destino_final }}</h2>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-warning btn-sm fw-bold px-3 shadow-sm" [routerLink]="['/reservas/editar', reserva.id]">
        <i class="bi bi-pencil-square me-1"></i> Editar Legajo
      </button>
      <select class="form-select form-select-sm w-auto fw-bold" [(ngModel)]="reserva.estado" (change)="cambiarEstado()">
        <option value="ABIERTO">üü¢ ABIERTO</option>
        <option value="CERRADO">üî¥ CERRADO</option>
      </select>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-3">
      <div class="glass-card mb-3 shadow-sm">
        <h3 class="section-title">Informaci√≥n Base</h3>
        <div class="mb-2"><small class="label-tech">TITULAR</small>
          <div class="fw-bold">{{ reserva.nombre_titular }}</div>
        </div>
        <div class="mb-2"><small class="label-tech">OPERADOR</small>
          <div>{{ reserva.operador_mayorista }}</div>
        </div>
        <div class="mb-2"><small class="label-tech">SALIDA / REGRESO</small>
          <div class="small fw-bold">{{ reserva.fecha_viaje_salida | date:'dd/MM/yy' }} - {{ reserva.fecha_viaje_regreso
            | date:'dd/MM/yy' }}</div>
        </div>
      </div>

      <div class="glass-card mb-3 shadow-sm border-start border-4 border-danger bg-white" *ngIf="reserva">
        <h3 class="section-title text-danger">Control de Vencimiento</h3>
        <div class="mb-1">
          <small class="label-tech">FECHA L√çMITE DE PAGO</small>
          <input type="date" class="form-control form-control-sm mb-2 shadow-none border-danger border-opacity-25"
            [(ngModel)]="fechaLimiteEditable">

          <div
            class="p-1 mb-2 bg-danger bg-opacity-10 text-danger extra-small rounded border border-danger border-opacity-25 text-center fw-bold"
            *ngIf="fechaLimiteEditable && today && (fechaLimiteEditable <= (today | date:'yyyy-MM-dd')!)">
            <i class="bi bi-exclamation-triangle-fill"></i> ¬°PLAZO VENCIDO!
          </div>

          <div class="extra-small text-muted mb-2 px-1" *ngIf="!reserva.fecha_limite_pago">
            <i class="bi bi-info-circle-fill me-1"></i> Calculado por defecto (30 d√≠as antes).
          </div>

          <button class="btn btn-danger btn-sm w-100 fw-bold shadow-sm" (click)="actualizarFechaPago()">
            <i class="bi bi-save me-1"></i> FIJAR FECHA
          </button>
        </div>
      </div>

      <div class="glass-card shadow-sm">
        <h3 class="section-title">Pasajeros</h3>
        <div *ngFor="let p of reserva.pasajeros" class="p-2 border rounded mb-2 bg-light">
          <div class="fw-bold small">{{ p.nombre_completo }}</div>
          <div class="text-muted extra-small">ID: {{ p.dni_pasaporte }} | {{ p.tipo_pasajero }}</div>
          <div class="text-danger extra-small mt-1" *ngIf="p.notas_medicas_alergias">‚ö†Ô∏è {{ p.notas_medicas_alergias }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="glass-card h-100 shadow-sm">
        <h3 class="section-title">Itinerario Detallado</h3>
        <div *ngFor="let s of reserva.servicios_items" class="p-3 border rounded mb-3 shadow-xs bg-white">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge" [ngClass]="{
              'bg-primary': s.tipo_item === 'VUELO',
              'bg-info': s.tipo_item === 'HOTEL',
              'bg-dark': s.tipo_item === 'CRUCERO',
              'bg-secondary': s.tipo_item === 'SERVICIO'
            }">{{ s.tipo_item }}</span>
            <small class="fw-bold text-muted" *ngIf="s.excursion_fecha">{{ s.excursion_fecha | date:'dd/MM/yy'
              }}</small>
          </div>

          <div [ngSwitch]="s.tipo_item">
            <div *ngSwitchCase="'VUELO'">
              <div class="fw-bold">{{ s.aerolinea }} (Vuelo {{ s.nro_vuelo }})</div>
              <div class="small">{{ s.origen }} ‚ûî {{ s.destino }} | PNR: <strong>{{ s.pnr }}</strong></div>
            </div>
            <div *ngSwitchCase="'HOTEL'">
              <div class="fw-bold">{{ s.hotel_nombre }} - {{ s.ciudad }}</div>
              <div class="extra-small text-muted">In: {{ s.check_in | date:'dd/MM/yy' }} | Out: {{ s.check_out |
                date:'dd/MM/yy' }}</div>
              <div class="extra-small mt-1">R√©gimen: {{ s.regimen }}</div>
            </div>
            <div *ngSwitchCase="'CRUCERO'">
              <div class="fw-bold">üö¢ {{ s.crucero_nombre }}</div>
              <div class="small">Cabina: {{ s.crucero_cabina }}</div>
              <div class="bg-light p-2 mt-2 rounded extra-small"><strong>Itinerario:</strong> {{ s.crucero_itinerario }}
              </div>
            </div>
            <div *ngSwitchCase="'SERVICIO'">
              <div class="fw-bold text-uppercase">{{ s.nombre_item }}</div>
              <div class="bg-light p-2 mt-2 rounded small" style="white-space: pre-wrap; font-style: italic;">
                {{ s.servicio_descripcion }}
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="!reserva.servicios_items || reserva.servicios_items.length === 0"
          class="text-center py-5 text-muted">
          <i class="bi bi-calendar-x fs-2"></i>
          <p>No hay tramos ni servicios cargados.</p>
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <div class="glass-card mb-3 shadow-sm" style="border-top: 4px solid var(--success);">
        <h3 class="section-title">Estado Contable</h3>
        <div class="row g-2 mb-3">
          <div class="col-6 p-2 bg-light border rounded text-center">
            <small class="label-tech">VENTA USD</small>
            <div class="fw-bold">{{ reserva.total_venta_final_usd | number:'1.2-2' }}</div>
          </div>
          <div class="col-6 p-2 bg-light border rounded text-center">
            <small class="label-tech">COSTO USD</small>
            <div class="fw-bold text-danger">{{ reserva.costo_total_operador_usd | number:'1.2-2' }}</div>
          </div>
        </div>
        <div class="p-2 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded text-center mb-2">
          <small class="label-tech text-danger">A COBRAR CLIENTE</small>
          <div class="h5 fw-bold text-danger m-0">USD {{ deudaCliente | number:'1.2-2' }}</div>
        </div>
        <div class="p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded text-center mb-3">
          <small class="label-tech text-warning">A PAGAR OPERADOR</small>
          <div class="h5 fw-bold text-dark m-0">USD {{ (deudaProveedor > 0 ? deudaProveedor : 0) | number:'1.2-2' }}
          </div>
        </div>
        <div class="p-3 bg-success bg-opacity-10 border border-success border-opacity-25 rounded text-center">
          <small class="label-tech text-success">GANANCIA ESTIMADA</small>
          <div class="h4 fw-bold text-success m-0">USD {{ (reserva.total_venta_final_usd -
            reserva.costo_total_operador_usd) | number:'1.2-2' }}</div>
        </div>
      </div>

      <div class="glass-card mb-3 no-print shadow-sm">
        <h3 class="section-title">Registrar Movimiento</h3>
        <select class="form-select form-select-sm mb-2" [(ngModel)]="nuevoPago.tipo_movimiento">
          <option value="PAGO_CLIENTE">Cobro al Cliente</option>
          <option value="PAGO_PROVEEDOR">Pago Operador</option>
        </select>
        <div class="row g-2 mb-2">
          <div class="col-7"><input type="number" class="form-control form-control-sm" [(ngModel)]="nuevoPago.monto"
              placeholder="Monto"></div>
          <div class="col-5">
            <select class="form-select form-select-sm" [(ngModel)]="nuevoPago.moneda">
              <option value="USD">USD</option>
              <option value="ARS">ARS</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
        </div>
        <button class="btn btn-dark w-100 btn-sm fw-bold" (click)="guardarPago()">Asentar Movimiento</button>
      </div>

      <div class="glass-card mb-3 shadow-sm">
        <h3 class="section-title">Documentaci√≥n / Archivos</h3>
        <div *ngFor="let arc of archivos"
          class="d-flex justify-content-between align-items-center p-2 border-bottom small bg-light bg-opacity-50 mb-1 rounded">
          <span class="text-truncate" style="max-width: 120px;">{{ arc.nombre_archivo }}</span>
          <div class="d-flex gap-2">
            <a [href]="'http://localhost:3000/' + arc.ruta_archivo" target="_blank" class="text-dark"><i
                class="bi bi-eye"></i></a>
            <button class="btn btn-link text-danger p-0" (click)="eliminarArchivo(arc.id)"><i
                class="bi bi-trash"></i></button>
          </div>
        </div>
        <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none;">
        <button class="btn btn-outline-dark btn-sm w-100 fw-bold" (click)="fileInput.click()"><i
            class="bi bi-cloud-upload me-2"></i>Subir Documento</button>
      </div>

      <div class="glass-card no-print shadow-sm">
        <h3 class="section-title">Generar Documentos</h3>
        <button class="btn btn-outline-primary btn-sm w-100 fw-bold mb-2"
          (click)="previsualizar('VOUCHER')">Voucher</button>
        <button class="btn btn-outline-success btn-sm w-100 fw-bold mb-2"
          (click)="previsualizar('COTIZACION')">Cotizaci√≥n</button>
        <button class="btn btn-sm btn-outline-secondary w-100" (click)="enviarPorMail()"><i
            class="bi bi-envelope me-1"></i>Enviar por Mail</button>
      </div>
    </div>
  </div>

  <div class="modal fade show d-block bg-dark bg-opacity-75" *ngIf="mostrarPreview"
    style="z-index: 2100; overflow-y: auto;">
    <div class="modal-dialog modal-xl">
      <div class="modal-content border-0">
        <div class="modal-header bg-white border-bottom no-print">
          <h5 class="modal-title fw-bold text-uppercase">Vista Previa: {{ tipoDoc }}</h5>
          <div class="ms-auto">
            <button class="btn btn-primary btn-sm me-2" (click)="imprimir()"><i class="bi bi-printer me-1"></i>
              Imprimir</button>
            <button class="btn btn-light btn-sm" (click)="mostrarPreview = false">Cerrar</button>
          </div>
        </div>
        <div class="modal-body bg-light">
          <div class="doc-a4-sheet shadow-lg mx-auto bg-white p-5" id="documento-imprimible">
            <div class="row border-bottom pb-3 mb-4">
              <div class="col-7">
                <h1 class="h2 fw-bold text-primary m-0 text-uppercase">{{ auth.getNombreEmpresa() }}</h1>
                <p class="small text-muted mb-0">Legajo EVT: Ley 18.829 | Empresa de Viajes y Turismo</p>
              </div>
              <div class="col-5 text-end border-start">
                <div class="badge bg-dark mb-2 text-uppercase">{{ tipoDoc === 'VOUCHER' ? 'Voucher de Servicios' :
                  'Estado de Cuenta' }}</div>
                <div class="fw-bold">Nro. Operaci√≥n: #{{ reserva.id }}</div>
                <div class="small">Fecha Emisi√≥n: {{ today | date:'dd/MM/yyyy' }}</div>
              </div>
            </div>
            <div [ngSwitch]="tipoDoc">
              <div *ngSwitchCase="'VOUCHER'">
                <h6 class="fw-bold border-bottom pb-2 mb-3">SERVICIOS CONFIRMADOS</h6>
                <div *ngFor="let s of reserva.servicios_items" class="p-3 border mb-2 rounded">
                  <span class="badge bg-primary mb-2">{{ s.tipo_item }}</span>
                  <div class="fw-bold h6">{{ s.hotel_nombre || s.aerolinea || s.nombre_item }}</div>
                  <p class="small text-muted mb-0">{{ s.servicio_descripcion }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>